<!doctype html>
<html>
<head>
	<title>Socket.IO chat</title>
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		body {
			font: 13px Helvetica, Arial;
		}

		form#chat {
			background: #000;
			padding: 3px;
			position: fixed;
			bottom: 0;
			width: 100%;
		}

		form#chat input {
			border: 0;
			padding: 10px;
			width: 90%;
			margin-right: .5%;
		}

		form#chat button {
			width: 9%;
			background: rgb(130, 224, 255);
			border: none;
			padding: 10px;
		}

		#messages {
			list-style-type: none;
			margin: 0;
			padding: 0;
		}

		#messages li {
			padding: 5px 10px;
		}

		#messages li:nth-child(odd) {
			background: #eee;
		}
	</style>
</head>
<body>
<div id="game"></div>
<form id="chat" action="">
	<input id="m" autocomplete="off"/>
	<button>Send</button>
</form>


<script src="/socket.io/socket.io.js"></script>
<script src="https://code.jquery.com/jquery-1.11.1.js"></script>
<script>
	jQuery(document).ready(function ($) {
		var socket = io();
		let roomID = parse_query_string(location.search).roomID;

//		let playerID = localStorage.getItem('playerID');
//		if (!playerID) {
//			playerID = Math.floor(Math.random() * 10000);
//			localStorage.setItem('playerID', playerID);
//		}

//		socket.on('roomEntered', (data) => {
//			if (!roomID) {
//				roomID = data.roomID;
//			}
//			history.pushState(null, 'RoomName', `${document.location}?roomID=${roomID}`);
//			console.log(`Room Entered: ${roomID}`);
//		});

//		if (!roomID) {
//			socket.emit('createNewRoom', {
//				playerID: playerID,
//				maxScore: 3,
//				chatEnable: false
//			});
//		} else {
//			socket.emit('knockToRoom', {
//				roomID,
//				playerID
//			});
//		}


		socket.on('startGame', () => {
			const gameDiv = $('#game');

			gameDiv.html(`
				<form id="gestures">
					<p><i>Выбирай!</i></p>
					<label><input type="radio" name="choice" value="rock">Камень</label><br>
					<label><input type="radio" name="choice" value="scissors">Ножницы</label><br>
					<label><input type="radio" name="choice" value="paper">Бумага</label><br>
					<label><input type="radio" name="choice" value="lizard">Ящерица</label><br>
					<label><input type="radio" name="choice" value="spock">Спок</label><br>
					<input type="submit" value="Отправить!">
				</form>
			`);

			gameDiv.on('submit', () => {
				socket.emit('playerActionGesture', {
					roomID,
					playerID,
					gesture: gameDiv.find('input[name="choice"]:checked').val()
				});
				return false;
			})
		});

		socket.on('matchResult', playerWin => {
			if (playerWin === false) {
				console.log("standoff");
			} else if (playerWin === playerID) {
				console.log("Win");
			} else {
				console.log("Loose");
			}
		});

		socket.on('gameResult', playerWin => {
			if (playerWin === false) {
				console.log("standoff");
			} else if (playerWin === playerID) {
				console.log("Win");
			} else {
				console.log("Loose");
			}
		});

		$('form#chat').submit(function () {
			socket.emit('msg', {
				roomName: room ? room : undefined,
				message: $('#m').val()
			});

			$('#m').val('');
			return false;
		});

		socket.on('msg', data => console.log(data));

		$(window).on('unload', function () {
			socket.emit('unload', {
				roomName: room ? room : undefined,
				roomIndex: roomIndex ? roomIndex : undefined,
			});
		});


		function parse_query_string(query) {
			var vars = query.slice(1).split("&");
			var query_string = {};
			for (var i = 0; i < vars.length; i++) {
				var pair = vars[i].split("=");
				// If first entry with this name
				if (typeof query_string[pair[0]] === "undefined") {
					query_string[pair[0]] = decodeURIComponent(pair[1]);
					// If second entry with this name
				} else if (typeof query_string[pair[0]] === "string") {
					var arr = [query_string[pair[0]], decodeURIComponent(pair[1])];
					query_string[pair[0]] = arr;
					// If third or later entry with this name
				} else {
					query_string[pair[0]].push(decodeURIComponent(pair[1]));
				}
			}
			return query_string;
		}
	});

</script>


</body>
</html>